<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- 上述3个meta标签*必须*放在最前面，任何其他内容都*必须*跟随其后！ -->
    <title>Bootstrap 101 Template</title>

    <!-- Bootstrap -->
    <link href="https://cdn.bootcss.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet">

    <!-- HTML5 shim 和 Respond.js 是为了让 IE8 支持 HTML5 元素和媒体查询（media queries）功能 -->
    <!-- 警告：通过 file:// 协议（就是直接将 html 页面拖拽到浏览器中）访问页面时 Respond.js 不起作用 -->
    <!--[if lt IE 9]>
      <script src="https://cdn.bootcss.com/html5shiv/3.7.3/html5shiv.min.js"></script>
      <script src="https://cdn.bootcss.com/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
  </head>
  <body>
   <div class="container">
       <Form>
           <div class="from-group">
               <label for="fileUpload">请选择上传文件</label>
               <input class="form-control" type="file" id="fileUpload" name="fileUpload" onchange="fileSelect()">
           </div>
           <div class="from-group">
               <input type="button" onclick="uploadFile()" class="btn btn-default" value="上传">
           </div>
           <div>
               <table class="table table-striped">
                   <tr>
                       <td>文件名</td>
                       <td>文件大小</td>
                       <td>文件类型</td>
                   </tr>
                   <tr>
                       <td id="fileName"></td>
                       <td id="fileSize"></td>
                       <td id="fileType"></td>
                   </tr>
               </table>
           </div>
           <div>
               <table class="table table-striped">
                   <tr>
                       <td>当前速度</td>
                       <td>剩余时间</td>
                       <td>当前进度</td>
                   </tr>
                   <tr>
                       <td id="speed"></td>
                       <td id="remaining"></td>
                       <td id="stage"></td>
                   </tr>
               </table>
           </div>
           <div class="progress">
               <div class="progress-bar" id="progressBar" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%;"></div>
           </div>
       </Form>
   </div>

    <!-- jQuery (Bootstrap 的所有 JavaScript 插件都依赖 jQuery，所以必须放在前边) -->
    <script src="https://cdn.bootcss.com/jquery/1.12.4/jquery.min.js"></script>
    <!-- 加载 Bootstrap 的所有 JavaScript 插件。你也可以根据需要只加载单个插件。 -->
    <script src="https://cdn.bootcss.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
   <script>
       function change(size) {
  /*         $('#progressBar').width(0)
           $('#progressBar').attr('aria-valuenow',0)*/
           var fileSize = 0;
           if(size>1024*1024){
               fileSize = Math.round(size/(1024*1024)) + 'MB';
           }else {
               fileSize = Math.round(size/(1024) )+ 'KB';
           }
           return fileSize
       }
       function fileSelect() {
           var file = $('#fileUpload')[0].files[0];
           if(file){
               $('#fileName').html(file.name);
               $('#fileSize').html(change(file.size));
               $('#fileType').html(file.type);
           }
       }
       var  success = error = abort = function () {};
       var last = 0;
       function progress(event) {
           var file = $('#fileUpload')[0].files[0];
           if(file){

           }
           var percent = Math.round(event.loaded*100/event.total);//上传的进度
           $('#progressBar').width(percent+"%");
           $('#progressBar').attr('aria-valuenow',percent);

           //上传速度
           var diff = event.loaded - last;
           last = event.loaded
           $('#speed').html(change(diff))
           $('#stage').html(change(event.loaded));
           $('#remaining').html(((event.total-event.loaded)/diff).toFixed(0)+'秒');

       }
       function uploadFile() {
           var file = $('#fileUpload')[0].files[0];
           var shardSize = 2*1024*1024;
           var shardCount = Math.ceil(file.size/shardSize);
           for (var i=0;i<shardCount;i++){
               var start = i*shardSize;
               var end = Math.min(file.size,start+shardSize);
               var fd = new FormData();

               fd.append('data',file.slice(start,end));
               fd.append('name','fileUpload.wmv');
               fd.append('total',shardCount);
               fd.append('index',i+1);
               fd.append('size',shardSize);


               var xhr = new XMLHttpRequest();
               xhr.addEventListener('load',success,false);//上传完成
               xhr.open('POST','/post');
               xhr.send(fd);
           }

       }
   </script>
  </body>
</html>